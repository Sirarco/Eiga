<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineMatch Pro v3</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¿</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mint: #e2f3f5; --lavender: #f3e8ff; --peach: #fff1e6; }
        body { background: linear-gradient(135deg, var(--mint), var(--lavender)); min-height: 100vh; color: #2d3748; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px; }
        .genre-bubble { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .genre-bubble.selected { transform: scale(1.1); border-color: #8b5cf6; background-color: #8b5cf6 !important; color: white !important;}
        .tab-btn.active { color: #8b5cf6; border-bottom: 3px solid #8b5cf6; }
        .animate-up { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .tag-fav { cursor: pointer; transition: 0.2s; display: inline-block; }
        .tag-fav:active { transform: scale(0.9); }
    </style>
</head>
<body class="p-4 pb-20">

    <div id="loading-screen" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-[100] backdrop-blur-md">
        <div class="animate-bounce text-6xl mb-4 shadow-xl rounded-full bg-white p-4">ğŸ¿</div>
        <p class="font-black text-purple-900 animate-pulse tracking-widest text-sm uppercase">Preparando la sala...</p>
    </div>

    <div id="user-selection" class="hidden flex flex-col items-center justify-center h-screen space-y-8">
        <h1 class="text-5xl font-black text-purple-900 tracking-tighter drop-shadow-sm">CineMatch</h1>
        <div id="profile-container" class="flex flex-wrap justify-center gap-6 w-full px-4"></div>
    </div>

    <div id="app-main" class="hidden max-w-md mx-auto space-y-4">
        <header class="flex justify-between items-center bg-white/50 p-3 rounded-3xl shadow-sm backdrop-blur-sm border border-white">
            <div class="flex items-center gap-3">
                <button id="main-avatar" class="text-3xl bg-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg active:scale-90 border-2 border-purple-100"></button>
                <div>
                    <p class="text-[9px] font-black text-purple-400 uppercase tracking-widest">Es tu turno,</p>
                    <h2 id="welcome" class="text-2xl font-black text-purple-900 leading-none"></h2>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-white p-3 rounded-full text-sm shadow-md active:scale-90 font-bold">ğŸ”„</button>
        </header>

        <nav class="flex justify-around bg-white/70 rounded-2xl overflow-hidden shadow-sm backdrop-blur-sm border border-white">
            <button onclick="showTab('explorar')" id="btn-explorar" class="tab-btn active p-3 font-black text-[10px] uppercase flex-1">ğŸ” Buscar</button>
            <button onclick="showTab('prioridades')" id="btn-prioridades" class="tab-btn p-3 font-black text-[10px] uppercase flex-1">ğŸ”¥ Pendientes</button>
            <button onclick="showTab('historial')" id="btn-historial" class="tab-btn p-3 font-black text-[10px] uppercase flex-1">âœ… Vistas</button>
            <button onclick="showTab('favoritos')" id="btn-favoritos" class="tab-btn p-3 font-black text-[10px] uppercase flex-1">â­ Favoritos</button>
        </nav>

        <section id="tab-explorar" class="tab-content space-y-4 animate-up">
            <div class="glass p-5 space-y-4">
                <div id="genre-container" class="flex flex-wrap gap-2 mt-1"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <select id="region" class="w-full p-2 mt-1 bg-white/70 rounded-xl border-none text-[11px] font-bold text-gray-800 shadow-sm">
                            <option value="">ğŸŒ PaÃ­s (Todos)</option>
                            <option value="CL">ğŸ‡¨ğŸ‡± Chile</option><option value="US">ğŸ‡ºğŸ‡¸ USA</option><option value="ES">ğŸ‡ªğŸ‡¸ EspaÃ±a</option>
                            <option value="KR">ğŸ‡°ğŸ‡· Corea</option><option value="JP">ğŸ‡¯ğŸ‡µ JapÃ³n</option><option value="IN">ğŸ‡®ğŸ‡³ India</option>
                        </select>
                    </div>
                    <div>
                        <select id="duration" class="w-full p-2 mt-1 bg-white/70 rounded-xl border-none text-[11px] font-bold text-gray-800 shadow-sm">
                            <option value="400">â±ï¸ DuraciÃ³n (Todas)</option>
                            <option value="90">â³ Corta (-1h 30m)</option>
                            <option value="120">ğŸ¬ Normal (-2h)</option>
                            <option value="180">ğŸ¿ Ã‰pica (-3h)</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <select id="decade" class="w-full p-2 bg-white/70 rounded-xl border-none text-[11px] font-bold text-gray-800 shadow-sm">
                            <option value="">ğŸ“… Ã‰poca (Cualquiera)</option>
                            <option value="2020">âœ¨ 2020s (Lo Nuevo)</option>
                            <option value="2010">ğŸ“± 2010s</option>
                            <option value="2000">ğŸ’¿ 2000s</option>
                            <option value="1990">ğŸ“¼ 90s</option>
                            <option value="1980">ğŸ“» 80s</option>
                            <option value="classic">ğŸ© ClÃ¡sicos (-1980)</option>
                        </select>
                    </div>
                </div>
                <button onclick="fetchMovies(false)" class="w-full py-3 bg-purple-600 text-white rounded-xl font-black shadow-lg shadow-purple-300 active:scale-95 text-sm">âœ¨ BUSCAR âœ¨</button>
            </div>
            
            <div id="search-title" class="font-black text-purple-900 pl-2 hidden">Resultados:</div>
            <div id="movie-results" class="space-y-3"></div>
            <button id="btn-load-more" onclick="fetchMovies(true)" class="hidden w-full py-3 bg-white text-purple-600 rounded-xl font-black shadow-sm mt-4 active:scale-95 border border-purple-100 text-xs">Cargar mÃ¡s resultados â¬‡ï¸</button>
        </section>

        <section id="tab-prioridades" class="tab-content hidden space-y-3 animate-up"></section>
        
        <section id="tab-historial" class="tab-content hidden space-y-3 animate-up"></section>

        <section id="tab-favoritos" class="tab-content hidden space-y-3 animate-up">
            <h3 class="font-black text-sm text-purple-900 pl-2">Mis Favoritos â­</h3>
            <p class="text-[10px] text-gray-500 pl-2 leading-tight">Toca un actor o director para ver todas sus pelÃ­culas.</p>
            <div id="fav-list" class="grid grid-cols-2 gap-3 mt-3"></div>
        </section>
    </div>

    <div id="movie-detail-modal" class="fixed inset-0 bg-black/80 hidden flex flex-col justify-end z-[200] backdrop-blur-sm transition-all">
        <div class="bg-white rounded-t-[30px] w-full max-h-[90vh] overflow-y-auto animate-up flex flex-col relative pb-6 shadow-2xl">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 bg-white/20 backdrop-blur-lg text-white w-8 h-8 rounded-full font-black text-sm z-30 flex items-center justify-center shadow border border-white/30">âœ•</button>
            <div id="detail-header-bg" class="w-full h-48 bg-cover bg-center relative rounded-t-[30px]">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm z-10"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-white via-white/80 to-transparent z-20"></div>
            </div>
            <div class="px-6 -mt-20 relative z-30">
                <div class="flex gap-4 items-end mb-4">
                    <img id="detail-poster-img" src="" class="w-24 rounded-xl shadow-xl border-2 border-white object-cover bg-gray-200">
                    <div class="pb-1">
                        <h2 id="detail-title" class="text-xl font-black text-gray-900 leading-tight"></h2>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span id="detail-year" class="text-[9px] font-black text-white bg-purple-600 px-2 py-0.5 rounded uppercase"></span>
                            <span id="detail-rating" class="text-[9px] font-black text-gray-700 bg-purple-100 px-2 py-0.5 rounded"></span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl text-xs text-gray-600 leading-relaxed shadow-inner border border-gray-100">
                    <p id="detail-overview" class="italic"></p>
                </div>
                <div class="grid grid-cols-2 gap-3 text-xs mt-3">
                    <div class="bg-white p-3 rounded-xl border border-purple-50 shadow-sm">
                        <p class="font-black text-purple-400 uppercase text-[8px] mb-1">Director</p>
                        <div id="detail-director" class="font-bold text-gray-800 leading-tight"></div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-purple-50 shadow-sm">
                        <p class="font-black text-purple-400 uppercase text-[8px] mb-1">Elenco Principal</p>
                        <div id="detail-cast" class="font-bold text-gray-800 leading-tight space-y-1"></div>
                    </div>
                </div>
                <div id="detail-actions" class="pt-5 space-y-2">
                    </div>
            </div>
        </div>
    </div>

    <div id="feedback-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[300] backdrop-blur-sm">
        <div class="bg-white p-6 w-full max-w-sm space-y-4 rounded-3xl animate-up shadow-2xl">
            <h3 class="font-black text-purple-900 text-lg text-center">Â¿QuÃ© tal estuvo?</h3>
            <p id="f-movie-title" class="text-xs font-bold text-gray-500 text-center uppercase tracking-widest bg-gray-50 py-2 rounded-lg"></p>
            <select id="f-rating" class="w-full p-3 rounded-xl bg-purple-50 font-bold border-none text-sm text-gray-800 outline-none">
                <option value="ğŸ˜ Obra Maestra">ğŸ˜ Obra Maestra</option><option value="ğŸ˜Š Muy buena">ğŸ˜Š Muy buena</option>
                <option value="ğŸ˜ Pasable">ğŸ˜ Pasable</option><option value="ğŸ’© Mala">ğŸ’© Mala</option>
            </select>
            <textarea id="f-comment" placeholder="Tu opiniÃ³n..." class="w-full p-3 rounded-xl bg-purple-50 text-sm h-20 border-none outline-none"></textarea>
            <div class="flex gap-2">
                <button onclick="closeFeedbackModal()" class="py-3 px-4 bg-gray-100 text-gray-600 rounded-xl font-bold">Cancelar</button>
                <button onclick="submitFeedback()" class="flex-1 py-3 bg-green-500 text-white rounded-xl font-black shadow-lg shadow-green-200">GUARDAR VISTA âœ…</button>
            </div>
        </div>
    </div>

    <script>
        // === TU CONFIGURACIÃ“N AQUÃ ===
        const TMDB_KEY = '366d109fec623ff7a4227017bfd58f0b'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwCW3SovPKFtX_w_Ou5pYhVq7AEQRHEJdj19Jz4aFlw8eMrB84UVGVgqZoI3OdVHiJ3/exec';

        let currentUser = "";
        let selectedGenres = [];
        let globalHistory = [];
        let globalFavorites = [];
        let profiles = [];
        let currentMovieData = null; 
        let activeMovieIdForFeedback = null;
        let searchPage = 1;
        let searchMode = 'discover'; // 'discover' o 'person'
        let searchPersonId = null;

        const genres = [
            {id:28,name:"AcciÃ³n"}, {id:35,name:"Comedia"}, {id:18,name:"Drama"}, {id:27,name:"Terror"},
            {id:10749,name:"Romance"}, {id:878,name:"Sci-Fi"}, {id:53,name:"Thriller"}, {id:16,name:"AnimaciÃ³n"}
        ];

        window.onload = async () => {
            try {
                const res = await fetch(`${GAS_URL}?action=getProfiles`);
                profiles = await res.json();
                renderProfiles();
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('user-selection').classList.remove('hidden');
            } catch(e) { alert("Error de conexiÃ³n. Revisa Apps Script."); }
        };

        function renderProfiles() {
            const container = document.getElementById('profile-container');
            container.innerHTML = "";
            profiles.forEach(p => {
                container.innerHTML += `<button onclick="selectUser('${p.user}', '${p.emoji}')" class="flex flex-col items-center"><div class="w-20 h-20 bg-white rounded-full mb-2 shadow-xl flex items-center justify-center text-4xl border-4 border-white active:scale-90">${p.emoji}</div><span class="font-black text-purple-900">${p.user}</span></button>`;
            });
        }

        async function selectUser(user, emoji) {
            currentUser = user;
            document.getElementById('user-selection').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            document.getElementById('welcome').innerText = user;
            document.getElementById('main-avatar').innerText = emoji;
            renderGenres();
            showTab('explorar');
            await loadData();
        }

        async function loadData() {
            try {
                const [histRes, favRes] = await Promise.all([
                    fetch(`${GAS_URL}?action=getHistory`),
                    fetch(`${GAS_URL}?action=getFavorites`)
                ]);
                globalHistory = await histRes.json();
                globalFavorites = await favRes.json();
                if(!Array.isArray(globalFavorites)) globalFavorites = []; // Seguro
                renderWatchlist();
                renderHistoryTab();
                renderFavoritesTab();
            } catch(e) { console.log("Historial o Favoritos vacÃ­os."); }
        }

        function renderGenres() {
            const container = document.getElementById('genre-container');
            container.innerHTML = "";
            genres.forEach(g => {
                const b = document.createElement('div');
                b.className = 'genre-bubble px-3 py-1.5 text-[10px] font-black uppercase rounded-lg text-gray-600 bg-white/70 shadow-sm';
                b.innerText = g.name;
                b.onclick = () => {
                    if(selectedGenres.includes(g.id)) { 
                        selectedGenres = selectedGenres.filter(i=>i!==g.id); b.classList.remove('selected'); 
                    } else if(selectedGenres.length < 3) { 
                        selectedGenres.push(g.id); b.classList.add('selected'); 
                    }
                };
                container.appendChild(b);
            });
        }

        // --- SISTEMA DE BÃšSQUEDA Y PAGINACIÃ“N ---
        async function fetchMovies(isLoadMore = false) {
            const container = document.getElementById('movie-results');
            const btnMore = document.getElementById('btn-load-more');
            document.getElementById('search-title').classList.remove('hidden');
            
            if(!isLoadMore) {
                searchPage = 1;
                searchMode = 'discover';
                container.innerHTML = "<p class='text-center p-6 text-xs font-bold text-purple-400 animate-pulse uppercase'>Buscando...</p>";
                btnMore.classList.add('hidden');
            } else {
                searchPage++;
                btnMore.innerText = "Cargando...";
            }

            let url = "";
            if (searchMode === 'discover') {
                const genreIds = selectedGenres.join(',');
                const region = document.getElementById('region').value;
                const maxDur = document.getElementById('duration').value;
                const decade = document.getElementById('decade').value;

                url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_KEY}&language=es-ES&sort_by=popularity.desc&page=${searchPage}&with_runtime.lte=${maxDur}`;
                if(genreIds) url += `&with_genres=${genreIds}`;
                if(region) url += `&with_origin_country=${region}`;
                
                if(decade === "classic") { url += `&primary_release_date.lte=1979-12-31`; } 
                else if(decade) {
                    const yearStart = parseInt(decade);
                    url += `&primary_release_date.gte=${yearStart}-01-01&primary_release_date.lte=${yearStart+9}-12-31`;
                }
            } else if (searchMode === 'person') {
                // BÃºsqueda por actor/director
                url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_KEY}&language=es-ES&sort_by=popularity.desc&page=${searchPage}&with_people=${searchPersonId}`;
            }

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if(!isLoadMore) container.innerHTML = "";
                if(data.results.length === 0 && !isLoadMore) {
                    container.innerHTML = "<p class='text-center text-xs font-bold text-gray-500'>No hay resultados.</p>";
                    return;
                }

                data.results.forEach(m => {
                    const posterUrl = m.poster_path ? `https://image.tmdb.org/t/p/w200${m.poster_path}` : 'https://via.placeholder.com/200x300?text=Sin+Poster';
                    
                    // Buscar estado del usuario para esta peli
                    const myInteractions = globalHistory.filter(h => h.usuario === currentUser && h.id_tmdb == m.id);
                    const lastState = myInteractions.length > 0 ? myInteractions[myInteractions.length - 1] : null;
                    let badge = '';
                    if(lastState) {
                        if(lastState.vista_completa === "TRUE") badge = 'âœ… VISTA';
                        else if(lastState.vista_completa === "FALSE") badge = 'ğŸ”¥ PENDIENTE';
                    }

                    container.innerHTML += `
                        <div onclick="openMovieDetail(${m.id})" class="glass p-3 flex gap-3 animate-up shadow-sm cursor-pointer hover:bg-white/90 group">
                            <img src="${posterUrl}" class="w-16 h-24 rounded-lg object-cover shadow border border-white">
                            <div class="flex-1 flex flex-col justify-center">
                                ${badge ? `<span class="text-[8px] font-black ${badge.includes('VISTA') ? 'text-green-600 bg-green-100' : 'text-orange-600 bg-orange-100'} px-2 py-0.5 rounded w-max mb-1">${badge}</span>` : ''}
                                <h4 class="font-black text-sm leading-tight text-gray-800">${m.title}</h4>
                                <p class="text-[9px] text-gray-500 font-bold uppercase mt-1">${m.release_date ? m.release_date.split('-')[0] : 'N/A'} â€¢ â­ ${m.vote_average.toFixed(1)}</p>
                            </div>
                        </div>`;
                });

                if(data.page < data.total_pages) {
                    btnMore.classList.remove('hidden');
                    btnMore.innerText = "Cargar mÃ¡s resultados â¬‡ï¸";
                } else { btnMore.classList.add('hidden'); }

            } catch(e) { if(!isLoadMore) container.innerHTML = "<p class='text-center text-xs text-red-500 font-bold'>Error.</p>"; }
        }

        async function fetchMoviesByPerson(personId, personName) {
            showTab('explorar');
            searchMode = 'person';
            searchPersonId = personId;
            document.getElementById('search-title').innerText = `PelÃ­culas de: ${personName}`;
            await fetchMovies(false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- FICHA TÃ‰CNICA UNIVERSAL Y FAVORITOS ---
        function checkFav(id) {
            return globalFavorites.some(f => f.user === currentUser && String(f.id) === String(id));
        }

        async function toggleFav(type, id, name) {
            event.stopPropagation(); // Evita que cierre modales si hay clicks raros
            const isFav = checkFav(id);
            
            // Actualizar UI Inmediatamente (Optimistic UI)
            const icon = document.getElementById(`fav-icon-${id}`);
            if(icon) icon.innerText = isFav ? "â˜†" : "â­";
            
            if(isFav) globalFavorites = globalFavorites.filter(f => !(f.user === currentUser && String(f.id) === String(id)));
            else globalFavorites.push({user: currentUser, tipo: type, id: id, nombre: name});
            
            // Enviar a Backend
            await fetch(GAS_URL, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({ action: 'toggleFavorite', user: currentUser, tipo: type, id_persona: id, nombre: name }) 
            });
            renderFavoritesTab();
        }

        async function openMovieDetail(movieId) {
            const modal = document.getElementById('movie-detail-modal');
            modal.classList.remove('hidden');
            document.getElementById('detail-title').innerText = "Cargando...";
            document.getElementById('detail-director').innerHTML = "";
            document.getElementById('detail-cast').innerHTML = "";

            try {
                const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_KEY}&language=es-ES&append_to_response=credits`);
                const det = await res.json();

                const directorObj = det.credits.crew.find(c => c.job === 'Director');
                const castObjs = det.credits.cast.slice(0, 3);
                
                const year = det.release_date ? det.release_date.split('-')[0] : 'N/A';
                document.getElementById('detail-header-bg').style.backgroundImage = `url(https://image.tmdb.org/t/p/w500${det.backdrop_path || det.poster_path})`;
                document.getElementById('detail-poster-img').src = det.poster_path ? `https://image.tmdb.org/t/p/w300${det.poster_path}` : 'https://via.placeholder.com/300x450';
                document.getElementById('detail-title').innerText = det.title;
                document.getElementById('detail-year').innerText = `${year} â€¢ ${det.runtime} MIN`;
                document.getElementById('detail-rating').innerText = `â­ ${det.vote_average.toFixed(1)}`;
                document.getElementById('detail-overview').innerText = det.overview || "Sinopsis no disponible.";

                // Render Director con Estrella
                if(directorObj) {
                    const star = checkFav(directorObj.id) ? "â­" : "â˜†";
                    document.getElementById('detail-director').innerHTML = `<span class="tag-fav bg-gray-100 px-2 py-1 rounded-lg border border-gray-200" onclick="toggleFav('Director', ${directorObj.id}, '${directorObj.name.replace(/'/g,"")}')">${directorObj.name} <span id="fav-icon-${directorObj.id}" class="text-xs">${star}</span></span>`;
                } else { document.getElementById('detail-director').innerText = "Desconocido"; }

                // Render Actores con Estrella
                document.getElementById('detail-cast').innerHTML = castObjs.map(c => {
                    const star = checkFav(c.id) ? "â­" : "â˜†";
                    return `<div class="tag-fav bg-gray-100 px-2 py-1 rounded-lg border border-gray-200 w-max" onclick="toggleFav('Actor', ${c.id}, '${c.name.replace(/'/g,"")}')">${c.name} <span id="fav-icon-${c.id}" class="text-xs">${star}</span></div>`;
                }).join('');

                currentMovieData = { id: det.id, title: det.title.replace(/'/g, ""), poster: det.poster_path, director: directorObj?.name || "", cast: castObjs.map(c=>c.name).join(','), year: year };

                // Determinar estado actual (Para la Botonera)
                const myInteractions = globalHistory.filter(h => h.usuario === currentUser && String(h.id_tmdb) === String(det.id));
                const lastState = myInteractions.length > 0 ? myInteractions[myInteractions.length - 1] : null;
                
                const actionsDiv = document.getElementById('detail-actions');
                
                if (!lastState || lastState.vista_completa === "DESCARTADA") {
                    // Estado Nuevo
                    actionsDiv.innerHTML = `
                        <button onclick="changeInteractionState('Mucho', 'FALSE')" class="w-full py-3 bg-purple-600 text-white rounded-xl font-black shadow-lg shadow-purple-200 active:scale-95 text-xs">AÃ‘ADIR A PENDIENTES ğŸ”¥</button>
                    `;
                } else if (lastState.vista_completa === "FALSE") {
                    // EstÃ¡ Pendiente: OpciÃ³n de ver o descartar
                    actionsDiv.innerHTML = `
                        <button onclick="openFeedbackModal('${det.id}', '${det.title.replace(/'/g,"")}')" class="w-full py-3 bg-green-500 text-white rounded-xl font-black shadow-lg shadow-green-200 active:scale-95 text-xs mb-2">MARCAR COMO VISTA âœ…</button>
                        <button onclick="changeInteractionState('Ninguna', 'DESCARTADA')" class="w-full py-2 bg-gray-100 text-red-500 rounded-xl font-bold border border-red-100 active:scale-95 text-[10px] uppercase">ğŸ—‘ï¸ Quitar de Pendientes</button>
                    `;
                } else if (lastState.vista_completa === "TRUE") {
                    // EstÃ¡ Vista: OpciÃ³n de devolver a pendientes
                    actionsDiv.innerHTML = `
                        <div class="bg-green-50 text-green-700 p-3 rounded-xl text-center text-xs font-bold border border-green-200 mb-2">Ya la viste y le diste: ${lastState.calificacion}</div>
                        <button onclick="changeInteractionState('Finde', 'FALSE')" class="w-full py-2 bg-white text-purple-600 rounded-xl font-bold border border-purple-200 active:scale-95 text-[10px] uppercase">â†©ï¸ Devolver a Pendientes</button>
                    `;
                }

            } catch(e) { document.getElementById('detail-title').innerText = "Error."; }
        }

        function closeDetailModal() { document.getElementById('movie-detail-modal').classList.add('hidden'); }

        // --- SISTEMA EVENT SOURCING ---
        function getLatestStates() {
            // Retorna un Map con el Ãºltimo estado de cada peli para el usuario actual
            const myInteractions = globalHistory.filter(h => h.usuario === currentUser);
            const latest = new Map();
            myInteractions.forEach(h => latest.set(h.id_tmdb, h));
            return Array.from(latest.values());
        }

        function renderWatchlist() {
            const container = document.getElementById('tab-prioridades');
            const states = getLatestStates();
            const pending = states.filter(s => s.vista_completa === "FALSE" || s.vista_completa === false).reverse();
            
            container.innerHTML = "<h3 class='font-black text-sm text-purple-900 pl-2'>Mi Lista ğŸ“</h3>";
            if(pending.length === 0) {
                container.innerHTML += "<div class='glass p-6 text-center mt-2 border-dashed border-2 border-purple-200'><p class='text-xs text-purple-800 font-bold'>Lista limpia.</p></div>"; return;
            }

            pending.forEach(p => {
                container.innerHTML += `
                    <div onclick="openMovieDetail(${p.id_tmdb})" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-purple-50 mb-3 cursor-pointer active:scale-95 transition">
                        <div>
                            <p class="font-black text-[13px] text-gray-800 leading-tight">${p.titulo}</p>
                            <span class="inline-block px-2 py-0.5 rounded text-[8px] font-black uppercase mt-1 bg-purple-50 text-purple-600 border border-purple-100">${p.prioridad}</span>
                        </div>
                        <span class="text-xs">â”</span>
                    </div>`;
            });
        }

        function renderHistoryTab() {
            const container = document.getElementById('tab-historial');
            const states = getLatestStates();
            const views = states.filter(s => s.vista_completa === "TRUE" || s.vista_completa === true).reverse();

            container.innerHTML = "<h3 class='font-black text-sm text-purple-900 pl-2 mb-2'>PelÃ­culas Vistas ğŸ¿</h3>";
            if(views.length === 0) {
                container.innerHTML += "<div class='bg-white/50 p-6 text-center rounded-2xl'><p class='text-xs text-gray-500 font-bold'>AÃºn no hay reseÃ±as.</p></div>"; return;
            }

            views.forEach(h => {
                container.innerHTML += `
                    <div onclick="openMovieDetail(${h.id_tmdb})" class="bg-white p-4 rounded-2xl text-xs shadow-sm flex gap-3 mb-3 border border-purple-50 cursor-pointer active:scale-95 transition">
                        <div class="text-2xl pt-1">âœ…</div>
                        <div class="flex-1">
                            <p class="font-black text-gray-800 text-[13px] leading-tight">${h.titulo}</p>
                            <span class="text-[9px] font-black text-gray-700 bg-gray-100 px-2 py-1 rounded mt-1 inline-block">${h.calificacion}</span>
                        </div>
                    </div>`;
            });
        }

        function renderFavoritesTab() {
            const container = document.getElementById('fav-list');
            const myFavs = globalFavorites.filter(f => f.user === currentUser).reverse();
            
            container.innerHTML = "";
            if(myFavs.length === 0) {
                container.innerHTML = "<div class='col-span-2 text-center p-6 bg-white/50 rounded-xl'><p class='text-xs text-gray-500 font-bold'>No has aÃ±adido favoritos.</p><p class='text-[9px] mt-1'>Abre una pelÃ­cula y toca un director/actor.</p></div>";
                return;
            }

            myFavs.forEach(f => {
                container.innerHTML += `
                    <div onclick="fetchMoviesByPerson(${f.id}, '${f.nombre.replace(/'/g,"")}')" class="bg-white p-3 rounded-xl shadow-sm border border-purple-100 flex flex-col items-center text-center cursor-pointer active:scale-95 transition">
                        <div class="text-xl mb-1">${f.tipo === 'Director' ? 'ğŸ¬' : 'ğŸ­'}</div>
                        <p class="font-black text-[11px] text-purple-900 leading-tight">${f.nombre}</p>
                        <p class="text-[8px] uppercase font-bold text-gray-400 mt-1">${f.tipo}</p>
                    </div>
                `;
            });
        }

        // --- CAMBIOS DE ESTADO (Descartar, Devolver, etc) ---
        async function changeInteractionState(priority, watchedState) {
            const btn = event.target;
            btn.innerText = "â³..."; btn.disabled = true;

            const payload = { 
                action: 'saveInteraction', user: currentUser, movie_id: currentMovieData.id, 
                title: currentMovieData.title, poster: currentMovieData.poster, 
                director: currentMovieData.director, cast: currentMovieData.cast,
                year: currentMovieData.year, watched: watchedState, priority: priority,
                rating: "", comment: "" // Se blanquea al cambiar de estado manual
            };

            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            
            closeDetailModal();
            setTimeout(() => { loadData(); }, 800);
        }

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).classList.add('active');
        }

        function openFeedbackModal(id, title) {
            event.stopPropagation();
            closeDetailModal(); // Cierra el fondo si estÃ¡ abierto
            activeMovieIdForFeedback = id; 
            document.getElementById('f-movie-title').innerText = title;
            document.getElementById('feedback-modal').classList.remove('hidden');
        }
        function closeFeedbackModal() { document.getElementById('feedback-modal').classList.add('hidden'); }

        async function submitFeedback() {
            const btn = event.target;
            btn.innerText = "â³ Guardando..."; btn.disabled = true;
            
            // Re-rescatar data actual de la peli (si venimos del listado, quizas currentMovieData no estÃ¡ actualizado, pero el backend solo requiere ID, titulo, etc)
            // Para asegurar integridad, pasamos vacÃ­os los de API si no estÃ¡n, el backend los ignora.
            
            const data = {
                action: 'saveInteraction', user: currentUser, movie_id: activeMovieIdForFeedback,
                title: document.getElementById('f-movie-title').innerText, watched: "TRUE",
                rating: document.getElementById('f-rating').value, comment: document.getElementById('f-comment').value
            };
            
            await fetch(GAS_URL, { method:'POST', mode:'no-cors', body:JSON.stringify(data)});
            
            btn.innerText = "GUARDAR VISTA âœ…"; btn.disabled = false;
            closeFeedbackModal(); 
            setTimeout(() => { loadData(); showTab('historial'); }, 600);
        }
    </script>
</body>
</html>
