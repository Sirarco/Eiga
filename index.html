<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineMatch Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mint: #e2f3f5; --lavender: #f3e8ff; --peach: #fff1e6; }
        body { background: linear-gradient(135deg, var(--mint), var(--lavender)); min-height: 100vh; color: #2d3748; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 24px; }
        .genre-bubble { transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; }
        .genre-bubble.selected { transform: scale(1.1); border-color: #8b5cf6; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2); }
        .history-card { font-size: 0.8rem; border-left: 4px solid #8b5cf6; }
        .badge-watched { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 800; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-up { animation: slideUp 0.4s ease forwards; }
    </style>
</head>
<body class="p-4 pb-24">

    <div id="user-selection" class="flex flex-col items-center justify-center h-screen space-y-8">
        <h1 class="text-4xl font-black text-purple-900 tracking-tighter">CineMatch</h1>
        <div class="flex gap-4">
            <button onclick="selectUser('Maca')" class="flex flex-col items-center group">
                <div class="w-20 h-20 bg-pink-200 rounded-full mb-2 border-4 border-white shadow-xl flex items-center justify-center text-3xl group-active:scale-90 transition">üå∏</div>
                <span class="font-bold">Maca</span>
            </button>
            <button onclick="selectUser('Marco')" class="flex flex-col items-center group">
                <div class="w-20 h-20 bg-blue-200 rounded-full mb-2 border-4 border-white shadow-xl flex items-center justify-center text-3xl group-active:scale-90 transition">üòé</div>
                <span class="font-bold">Marco</span>
            </button>
            <button onclick="selectUser('Vicente')" class="flex flex-col items-center group">
                <div class="w-20 h-20 bg-green-200 rounded-full mb-2 border-4 border-white shadow-xl flex items-center justify-center text-3xl group-active:scale-90 transition">üéÆ</div>
                <span class="font-bold">Vicente</span>
            </button>
        </div>
    </div>

    <div id="app-main" class="hidden max-w-md mx-auto space-y-6 animate-up">
        <header class="flex justify-between items-center">
            <h2 id="welcome" class="text-2xl font-black text-purple-900"></h2>
            <button onclick="location.reload()" class="bg-white/50 p-2 rounded-full text-xs uppercase font-bold">üîÑ</button>
        </header>

        <section class="glass p-6 shadow-sm space-y-6">
            <div>
                <h3 class="text-xs font-black uppercase text-purple-400 mb-3 tracking-widest">G√©neros (M√°x 3)</h3>
                <div id="genre-container" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400">Regi√≥n</label>
                    <select id="region" class="w-full mt-1 p-3 bg-white/50 rounded-xl border-none text-sm font-bold">
                        <option value="US">USA</option>
                        <option value="ES">Espa√±a</option>
                        <option value="FR">Francia</option>
                        <option value="JP">Jap√≥n</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400">Vibe</label>
                    <select id="priority-select" class="w-full mt-1 p-3 bg-white/50 rounded-xl border-none text-sm font-bold">
                        <option value="Normal">Normal</option>
                        <option value="Quiero verla ya">Urgente üî•</option>
                    </select>
                </div>
            </div>

            <button onclick="fetchMovies()" class="w-full py-4 bg-purple-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition">
                GENERAR SUGERENCIAS
            </button>
        </section>

        <div id="movie-results" class="space-y-4"></div>

        <section id="history-section" class="mt-10 space-y-4">
            <h3 class="text-lg font-black text-purple-900 pl-2">Lo que han visto...</h3>
            <div id="history-list" class="space-y-3">
                </div>
        </section>
    </div>

    <script>
        const TMDB_KEY = '366d109fec623ff7a4227017bfd58f0b';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwCW3SovPKFtX_w_Ou5pYhVq7AEQRHEJdj19Jz4aFlw8eMrB84UVGVgqZoI3OdVHiJ3/exec';

        let currentUser = "";
        let selectedGenres = [];
        let globalHistory = [];

        const genres = [
            { id: 28, name: "Acci√≥n", color: "#fee2e2" }, { id: 35, name: "Comedia", color: "#fef3c7" },
            { id: 18, name: "Drama", color: "#e0e7ff" }, { id: 27, name: "Terror", color: "#ddd6fe" },
            { id: 10749, name: "Romance", color: "#fce7f3" }, { id: 878, name: "Sci-Fi", color: "#d1fae5" }
        ];

        async function selectUser(user) {
            currentUser = user;
            document.getElementById('user-selection').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            document.getElementById('welcome').innerText = `Hola, ${user}`;
            renderGenres();
            await loadHistory();
        }

        function renderGenres() {
            const container = document.getElementById('genre-container');
            container.innerHTML = "";
            genres.forEach(g => {
                const b = document.createElement('div');
                b.className = 'genre-bubble px-4 py-2 rounded-full text-[11px] font-black uppercase';
                b.style.backgroundColor = g.color;
                b.innerText = g.name;
                b.onclick = () => {
                    if(selectedGenres.includes(g.id)) {
                        selectedGenres = selectedGenres.filter(i => i !== g.id);
                        b.classList.remove('selected');
                    } else if(selectedGenres.length < 3) {
                        selectedGenres.push(g.id);
                        b.classList.add('selected');
                    }
                };
                container.appendChild(b);
            });
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "<p class='text-xs italic opacity-50 pl-2'>Sincronizando con Sheets...</p>";
            try {
                const res = await fetch(`${GAS_URL}?action=getHistory`);
                globalHistory = await res.json();
                list.innerHTML = "";
                
                globalHistory.slice(-5).reverse().forEach(item => {
                    list.innerHTML += `
                        <div class="glass p-3 history-card">
                            <div class="flex justify-between font-bold text-xs">
                                <span class="text-purple-700">${item.usuario}</span>
                                <span class="text-gray-400">${item.calificacion || 'Sin nota'}</span>
                            </div>
                            <p class="font-black text-sm">${item.titulo}</p>
                            ${item.comment ? `<p class="text-[10px] italic mt-1 text-gray-600">"${item.comment}"</p>` : ''}
                        </div>
                    `;
                });
            } catch (e) { list.innerHTML = "No se pudo cargar el historial."; }
        }

        async function fetchMovies() {
            const container = document.getElementById('movie-results');
            container.innerHTML = "<div class='text-center py-10 animate-bounce'>üçø</div>";
            
            const genreIds = selectedGenres.join(',');
            const region = document.getElementById('region').value;
            const priority = document.getElementById('priority-select').value;
            
            try {
                const res = await fetch(`https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_KEY}&with_genres=${genreIds}&with_origin_country=${region}&language=es-ES&sort_by=popularity.desc`);
                const data = await res.json();
                
                container.innerHTML = "";
                data.results.slice(0, 5).forEach(movie => {
                    const alreadySeen = globalHistory.find(h => h.id_tmdb == movie.id);
                    
                    container.innerHTML += `
                        <div class="glass p-4 flex gap-4 animate-up">
                            <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" class="w-20 h-28 rounded-xl object-cover">
                            <div class="flex flex-col justify-between flex-1">
                                <div>
                                    ${alreadySeen ? `<span class="badge-watched">VISTA POR ${alreadySeen.usuario.toUpperCase()}</span>` : ''}
                                    <h4 class="font-black text-md leading-tight mt-1">${movie.title}</h4>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">${movie.release_date.split('-')[0]}</p>
                                </div>
                                <button onclick="saveToSheet('${movie.id}', '${movie.title.replace(/'/g,"")}', '${priority}')" 
                                        class="w-full bg-white border-2 border-purple-200 text-purple-700 text-[10px] py-2 rounded-xl font-black uppercase active:bg-purple-600 active:text-white transition">
                                    A√±adir a pendientes
                                </button>
                            </div>
                        </div>
                    `;
                });
            } catch (e) { container.innerHTML = "Error de conexi√≥n."; }
        }

        async function saveToSheet(id, title, priority) {
            const comment = prompt("¬øAlg√∫n comentario inicial? (Opcional)");
            const data = {
                action: 'saveInteraction',
                user: currentUser,
                movie_id: id,
                title: title,
                priority: priority,
                comment: comment || "",
                watched: false
            };
            
            // UI Feedback
            const btn = event.target;
            btn.innerText = "GUARDANDO...";
            
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(data)
            });
            
            btn.innerText = "¬°LISTO! ‚úÖ";
            btn.style.borderColor = "#10b981";
            btn.style.color = "#059669";
            setTimeout(loadHistory, 2000);
        }
    </script>
</body>
</html>
